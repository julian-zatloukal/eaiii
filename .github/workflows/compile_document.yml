name: Build‑and‑merge‑notebooks‑PDF

on:
  push:
    branches: [ main ]
    paths:
      - '**/*.ipynb'
  workflow_dispatch:

jobs:
  pdf:
    runs-on: ubuntu-latest

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install build tools
        run: |
          python -m pip install --upgrade pip
          python -m pip install "nbconvert[webpdf]==7.16.6" pypdf==5.4.0
          # download a recent Chromium for nbconvert's webpdf exporter
          python -m pyppeteer install

      - name: Convert every notebook to PDF
        run: |
          mkdir -p build/pdfs
          find . -type f -name '*.ipynb' -print0 | while IFS= read -r -d '' nb; do
            jupyter nbconvert "$nb" --to webpdf --output-dir build/pdfs
          done

      - name: Merge PDFs into a single file
        run: |
          python <<'PY'
          import pathlib
          from pypdf import PdfMerger
          pdf_dir = pathlib.Path('build/pdfs')
          merger = PdfMerger()
          for pdf in sorted(pdf_dir.glob('*.pdf')):
              merger.append(pdf)
          output = pathlib.Path('build/all_notebooks_combined.pdf')
          output.parent.mkdir(parents=True, exist_ok=True)
          merger.write(output)
          merger.close()
          print(f'Created {output}')
          PY

      - name: Upload combined PDF
        uses: actions/upload-artifact@v4
        with:
          name: notebooks-pdf
          path: build/all_notebooks_combined.pdf
